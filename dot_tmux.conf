# -----------------------------------------------------------------------------
# General Settings
# -----------------------------------------------------------------------------

set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"

# Enable mouse support (like Zellij)
set -g mouse on

# Start windows and panes at 1, not 0 (more intuitive)
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Prevent shell from overriding window names
set-option -g allow-rename off

# Increase history limit
set -g history-limit 50000

# Faster command sequences (no delay for escape)
set -s escape-time 0

# Increase repeat time for repeatable commands
set -g repeat-time 300

# Focus events for vim/neovim
set -g focus-events on

# Allow passthrough of escape sequences (needed for notifications over SSH)
set -g allow-passthrough on

# Don't exit tmux when closing a session
set -g detach-on-destroy off

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity off

# Bell settings - pass bell to terminal for visual flash
set -g visual-bell off
set -g bell-action any
setw -g monitor-bell on

# -----------------------------------------------------------------------------
# Keybindings - Prefix
# -----------------------------------------------------------------------------

# Keep C-b as prefix, but also add C-a as secondary
unbind C-b
set -g prefix C-p
set -g prefix2 C-s
bind C-s send-prefix -2

# Reload config with prefix + r
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# -----------------------------------------------------------------------------
# Pane Management (Zellij-style)
# -----------------------------------------------------------------------------

# Split panes using | and - (more intuitive than % and ")
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind \\ split-window -h -c "#{pane_current_path}"  # Alternative without shift
bind _ split-window -v -c "#{pane_current_path}"

# Vim-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Alt + arrow keys for pane navigation (no prefix needed, like Zellij)
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Resize panes with prefix + HJKL
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Zoom pane (toggle fullscreen) - prefix + z (already default, but documenting)
# bind z resize-pane -Z

# Swap panes
bind > swap-pane -D
bind < swap-pane -U

# Break pane into new window
bind b break-pane

# Kill pane without confirmation
bind x kill-pane

# Synchronize panes (type in all panes at once)
bind S setw synchronize-panes

# -----------------------------------------------------------------------------
# Window Management
# -----------------------------------------------------------------------------

# New window in current path
bind c new-window -c "#{pane_current_path}"

# Window navigation
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Shift + arrow to switch windows (no prefix)
bind -n S-Left previous-window
bind -n S-Right next-window

# Move windows left/right
bind -r C-h swap-window -t -1 \; previous-window
bind -r C-l swap-window -t +1 \; next-window

# -----------------------------------------------------------------------------
# Session Management (Zellij-like with sesh)
# -----------------------------------------------------------------------------

# Fuzzy session picker with sesh (like Zellij's session manager)
bind p display-popup -E -w 60% -h 60% "\
  sesh connect $(\
    sesh list --icons | fzf --ansi \
      --height 100% \
      --border=rounded \
      --border-label=' Sessions ' \
      --prompt='âš¡ ' \
      --header='ctrl-a: all | ctrl-t: tmux | ctrl-x: zoxide | ctrl-d: kill' \
      --bind 'ctrl-a:change-prompt(âš¡ )+reload(sesh list --icons)' \
      --bind 'ctrl-t:change-prompt(ğŸªŸ )+reload(sesh list -t --icons)' \
      --bind 'ctrl-x:change-prompt(ğŸ“ )+reload(sesh list -z --icons)' \
      --bind 'ctrl-d:execute(tmux kill-session -t {2..})+reload(sesh list --icons)' \
      --preview-window 'right:50%' \
      --preview 'sesh preview {}' \
  )"

# Quick session switcher (simpler, without preview)
bind s display-popup -E -w 40% -h 50% "\
  tmux list-sessions -F '#{session_name}' | \
  fzf --reverse --header='Switch Session' | \
  xargs tmux switch-client -t"

# Create new session with name prompt
bind N command-prompt -p "New session name:" "new-session -s '%%'"

# -----------------------------------------------------------------------------
# Floating/Popup Terminal (Zellij's floating panes)
# -----------------------------------------------------------------------------

# Toggle floating terminal popup (Alt+f)
bind -n M-f display-popup -E -w 80% -h 80% -d "#{pane_current_path}"

# Persistent scratch popup (survives closing)
bind -n M-g display-popup -E -w 80% -h 80% "tmux new-session -A -s scratch -c ~"

# Popup for quick commands (htop, lazygit, etc.)
# Note: bind g is defined after TPM loads to override plugin bindings
bind G display-popup -E -w 90% -h 90% "/opt/homebrew/bin/htop"

# -----------------------------------------------------------------------------
# Copy Mode (Vim-style)
# -----------------------------------------------------------------------------

setw -g mode-keys vi

# Enter copy mode with prefix + v
bind v copy-mode

# Vim-style selection
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Also allow mouse selection to copy
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-and-cancel

# -----------------------------------------------------------------------------
# Status Bar Position
# -----------------------------------------------------------------------------

# Status bar at top (like Zellij default) - uncomment if preferred
# set -g status-position top

# Status bar at bottom (tmux default)
set -g status-position bottom

# -----------------------------------------------------------------------------
# Theme: Catppuccin (Mocha)
# -----------------------------------------------------------------------------

set -g @plugin 'catppuccin/tmux#v2.1.3'
set -g @catppuccin_flavor 'mocha'
set -g @catppuccin_window_status_style 'rounded'

# Window status - shows custom name if set, otherwise running process
set -g @catppuccin_window_text " #{?#{automatic-rename},#{pane_current_command},#W}"
set -g @catppuccin_window_current_text " #{?window_zoomed_flag,ğŸ” ,}#{?pane_synchronized,â›“ï¸  ,}#{?#{automatic-rename},#{pane_current_command},#W}"
set -g @catppuccin_window_status "icon"
set -g @catppuccin_window_current_background "#{@thm_mauve}"

# Status line modules
set -g status-left-length 100
set -g status-right-length 100
# Prefix indicator - shows "PREFIX" in red when prefix is pressed
set -g status-left "#{?client_prefix,#[bg=#{@thm_red}]#[fg=#{@thm_bg}] PREFIX ,}"
set -g status-right "#{E:@catppuccin_status_session}"
set -ag status-right "#{E:@catppuccin_status_directory}"

# Pane borders
set -g @catppuccin_pane_border_style "fg=#{@thm_surface_0}"
set -g @catppuccin_pane_active_border_style "fg=#{@thm_lavender}"

# -----------------------------------------------------------------------------
# Plugins
# -----------------------------------------------------------------------------

# TPM - Plugin Manager (required)
set -g @plugin 'tmux-plugins/tpm'

# Sensible defaults
set -g @plugin 'tmux-plugins/tmux-sensible'

# Better mouse support
set -g @plugin 'nhdaly/tmux-better-mouse-mode'

# Session management
set -g @plugin 'tmux-plugins/tmux-sessionist'

# Yank to system clipboard
set -g @plugin 'tmux-plugins/tmux-yank'

# Resurrect sessions after restart
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'

# Desktop notifications (works over SSH if terminal supports OSC 9)
set -g @plugin 'rickstaa/tmux-notify'
set -g @tnotify-verbose 'on'

# CPU/Memory in status bar (optional - uncomment to enable)
# set -g @plugin 'tmux-plugins/tmux-cpu'
# set -ag status-right "#{E:@catppuccin_status_cpu}"

# Menus for discoverability (like Zellij's hints)
set -g @plugin 'jaclu/tmux-menus'
bind m display-menu -T "#[align=centre]Quick Actions" \
  "Horizontal Split" h "split-window -h -c '#{pane_current_path}'" \
  "Vertical Split" v "split-window -v -c '#{pane_current_path}'" \
  "" \
  "New Window" n "new-window -c '#{pane_current_path}'" \
  "Kill Window" X "kill-window" \
  "" \
  "Rename Window" r "command-prompt -I '#W' 'rename-window \"%%\"'" \
  "Rename Session" R "command-prompt -I '#S' 'rename-session \"%%\"'" \
  "" \
  "Sync Panes" s "setw synchronize-panes" \
  "Reload Config" c "source-file ~/.tmux.conf; display 'Reloaded!'"

# -----------------------------------------------------------------------------
# Initialize TPM (keep this at the very bottom)
# -----------------------------------------------------------------------------
run '~/.tmux/plugins/tpm/tpm'

# -----------------------------------------------------------------------------
# Override plugin bindings (must be after TPM)
# -----------------------------------------------------------------------------

# Override sessionist's 'prefix + g' with lazygit popup
bind g display-popup -w 90% -h 90% -d "#{pane_current_path}" /opt/homebrew/bin/lazygit
